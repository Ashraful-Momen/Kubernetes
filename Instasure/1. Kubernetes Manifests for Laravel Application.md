# ================================
# NAMESPACE
# ================================
apiVersion: v1
kind: Namespace
metadata:
  name: laravel-app
---
# ================================
# SECRETS
# ================================
apiVersion: v1
kind: Secret
metadata:
  name: mysql-secret
  namespace: laravel-app
type: Opaque
data:
  mysql-root-password: cm9vdF9wYXNzd29yZA== # base64: root_password
  mysql-password: bGFyYXZlbF9wYXNzd29yZA== # base64: laravel_password
---
apiVersion: v1
kind: Secret
metadata:
  name: laravel-secret
  namespace: laravel-app
type: Opaque
data:
  app-key: YmFzZTY0OmVXUXZBbkE5cW4wbGVzOGFWOGJ1eCo2R3JkQmVuZ2ZxOXhaaEFndkVUcjA9 # base64: base64:eWQvAnA9qn0les8aV8bux+6GrdBengfq9xZhAgvETr0=
---
# ================================
# CONFIGMAPS
# ================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: laravel-app
data:
  default.conf: |
    server {
        listen 80;
        server_name _;
        root /var/www/html/public;
        index index.php index.html index.htm;

        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        location ~ \.php$ {
            fastcgi_pass laravel-app-service:9000;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            
            fastcgi_param HTTP_X_REAL_IP $remote_addr;
            fastcgi_param HTTP_X_FORWARDED_FOR $proxy_add_x_forwarded_for;
            fastcgi_param HTTP_X_FORWARDED_PROTO $scheme;
            fastcgi_param HTTP_X_FORWARDED_HOST $host;
            
            include fastcgi_params;
        }

        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header X-Content-Type-Options "nosniff" always;
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: php-config
  namespace: laravel-app
data:
  local.ini: |
    max_execution_time = 300
    max_input_time = 300
    memory_limit = 512M
    upload_max_filesize = 100M
    post_max_size = 100M
    max_file_uploads = 20
    session.gc_maxlifetime = 3600
    session.cookie_lifetime = 0
    display_errors = Off
    display_startup_errors = Off
    log_errors = On
    error_log = /var/log/php_errors.log
    opcache.enable = 1
    opcache.enable_cli = 1
    opcache.memory_consumption = 256
    opcache.interned_strings_buffer = 16
    opcache.max_accelerated_files = 10000
    opcache.revalidate_freq = 2
    opcache.fast_shutdown = 1
    realpath_cache_size = 32M
    realpath_cache_ttl = 600
    default_socket_timeout = 60
    auto_detect_line_endings = Off
    expose_php = Off
    allow_url_fopen = On
    allow_url_include = Off
    date.timezone = "UTC"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-config
  namespace: laravel-app
data:
  my.cnf: |
    [mysqld]
    default-authentication-plugin=mysql_native_password
    max_connections=200
    innodb_buffer_pool_size=256M
    innodb_log_file_size=64M
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: phpmyadmin-config
  namespace: laravel-app
data:
  uploads.ini: |
    max_execution_time = 0
    max_input_time = 0
    memory_limit = 2048M
    post_max_size = 2048M
    upload_max_filesize = 2048M
    max_input_vars = 20000
    default_socket_timeout = 600
    mysql.connect_timeout = 600
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: laravel-env
  namespace: laravel-app
data:
  APP_NAME: "Laravel"
  APP_ENV: "local"
  APP_DEBUG: "true"
  APP_URL: "http://36.255.69.72:8080"
  LOG_CHANNEL: "stack"
  LOG_LEVEL: "debug"
  DB_CONNECTION: "mysql"
  DB_HOST: "mysql-service"
  DB_PORT: "3306"
  DB_DATABASE: "laravel_db"
  DB_USERNAME: "laravel_user"
  BROADCAST_DRIVER: "log"
  CACHE_DRIVER: "redis"
  FILESYSTEM_DISK: "local"
  QUEUE_CONNECTION: "sync"
  SESSION_DRIVER: "redis"
  SESSION_LIFETIME: "120"
  SESSION_SECURE_COOKIES: "false"
  SESSION_SAME_SITE: "lax"
  SESSION_DOMAIN: ".36.255.69.72"
  SESSION_HTTPONLY: "true"
  REDIS_HOST: "redis-service"
  REDIS_PASSWORD: ""
  REDIS_PORT: "6379"
  MAIL_MAILER: "smtp"
  MAIL_HOST: "mailpit"
  MAIL_PORT: "1025"
  MAIL_FROM_ADDRESS: "hello@example.com"
---
# ================================
# PERSISTENT VOLUMES
# ================================
apiVersion: v1
kind: PersistentVolume
metadata:
  name: mysql-pv
  namespace: laravel-app
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-storage
  hostPath:
    path: /data/mysql
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: redis-pv
  namespace: laravel-app
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-storage
  hostPath:
    path: /data/redis
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: app-code-pv
  namespace: laravel-app
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-storage
  hostPath:
    path: /home/ashraful/gitlab_project/instasure-dockerized
---
# ================================
# PERSISTENT VOLUME CLAIMS
# ================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
  namespace: laravel-app
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: local-storage
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis-pvc
  namespace: laravel-app
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: local-storage
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: app-code-pvc
  namespace: laravel-app
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 5Gi
  storageClassName: local-storage
---
# ================================
# MYSQL DEPLOYMENT
# ================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql-deployment
  namespace: laravel-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        ports:
        - containerPort: 3306
        env:
        - name: MYSQL_DATABASE
          value: "laravel_db"
        - name: MYSQL_USER
          value: "laravel_user"
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: mysql-root-password
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: mysql-password
        volumeMounts:
        - name: mysql-storage
          mountPath: /var/lib/mysql
        - name: mysql-config
          mountPath: /etc/mysql/my.cnf
          subPath: my.cnf
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
      volumes:
      - name: mysql-storage
        persistentVolumeClaim:
          claimName: mysql-pvc
      - name: mysql-config
        configMap:
          name: mysql-config
---
# ================================
# REDIS DEPLOYMENT
# ================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-deployment
  namespace: laravel-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        ports:
        - containerPort: 6379
        volumeMounts:
        - name: redis-storage
          mountPath: /data
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      volumes:
      - name: redis-storage
        persistentVolumeClaim:
          claimName: redis-pvc
---
# ================================
# LARAVEL APP DEPLOYMENT
# ================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: laravel-app-deployment
  namespace: laravel-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: laravel-app
  template:
    metadata:
      labels:
        app: laravel-app
    spec:
      containers:
      - name: laravel-app
        image: instasure-dockerized_app:latest
        ports:
        - containerPort: 9000
        workingDir: /var/www/html
        envFrom:
        - configMapRef:
            name: laravel-env
        env:
        - name: APP_KEY
          valueFrom:
            secretKeyRef:
              name: laravel-secret
              key: app-key
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: mysql-password
        volumeMounts:
        - name: app-code
          mountPath: /var/www/html
        - name: php-config
          mountPath: /usr/local/etc/php/conf.d/local.ini
          subPath: local.ini
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        readinessProbe:
          tcpSocket:
            port: 9000
          initialDelaySeconds: 30
          periodSeconds: 10
        livenessProbe:
          tcpSocket:
            port: 9000
          initialDelaySeconds: 60
          periodSeconds: 30
      volumes:
      - name: app-code
        persistentVolumeClaim:
          claimName: app-code-pvc
      - name: php-config
        configMap:
          name: php-config
---
# ================================
# NGINX DEPLOYMENT
# ================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  namespace: laravel-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
        - containerPort: 443
        volumeMounts:
        - name: app-code
          mountPath: /var/www/html
        - name: nginx-config
          mountPath: /etc/nginx/conf.d/default.conf
          subPath: default.conf
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 5
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 30
          periodSeconds: 30
      volumes:
      - name: app-code
        persistentVolumeClaim:
          claimName: app-code-pvc
      - name: nginx-config
        configMap:
          name: nginx-config
---
# ================================
# NODE.JS DEPLOYMENT (for development)
# ================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: node-deployment
  namespace: laravel-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: node
  template:
    metadata:
      labels:
        app: node
    spec:
      containers:
      - name: node
        image: node:18-alpine
        workingDir: /var/www/html
        command: ["sh", "-c", "npm install && npm run dev"]
        volumeMounts:
        - name: app-code
          mountPath: /var/www/html
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "400m"
      restartPolicy: Never
      volumes:
      - name: app-code
        persistentVolumeClaim:
          claimName: app-code-pvc
---
# ================================
# PHPMYADMIN DEPLOYMENT
# ================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: phpmyadmin-deployment
  namespace: laravel-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: phpmyadmin
  template:
    metadata:
      labels:
        app: phpmyadmin
    spec:
      containers:
      - name: phpmyadmin
        image: phpmyadmin/phpmyadmin
        ports:
        - containerPort: 80
        env:
        - name: PMA_HOST
          value: "mysql-service"
        - name: PMA_PORT
          value: "3306"
        - name: PMA_USER
          value: "root"
        - name: PMA_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: mysql-root-password
        volumeMounts:
        - name: phpmyadmin-config
          mountPath: /usr/local/etc/php/conf.d/uploads.ini
          subPath: uploads.ini
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "200m"
      volumes:
      - name: phpmyadmin-config
        configMap:
          name: phpmyadmin-config
---
# ================================
# SERVICES
# ================================
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
  namespace: laravel-app
spec:
  selector:
    app: mysql
  ports:
  - name: mysql
    port: 3306
    targetPort: 3306
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: redis-service
  namespace: laravel-app
spec:
  selector:
    app: redis
  ports:
  - name: redis
    port: 6379
    targetPort: 6379
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: laravel-app-service
  namespace: laravel-app
spec:
  selector:
    app: laravel-app
  ports:
  - name: php-fpm
    port: 9000
    targetPort: 9000
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
  namespace: laravel-app
spec:
  selector:
    app: nginx
  ports:
  - name: http
    port: 80
    targetPort: 80
    nodePort: 30080
  - name: https
    port: 443
    targetPort: 443
    nodePort: 30443
  type: NodePort
---
apiVersion: v1
kind: Service
metadata:
  name: phpmyadmin-service
  namespace: laravel-app
spec:
  selector:
    app: phpmyadmin
  ports:
  - name: http
    port: 80
    targetPort: 80
    nodePort: 30081
  type: NodePort
---
# ================================
# EXTERNAL SERVICES (Optional)
# ================================
apiVersion: v1
kind: Service
metadata:
  name: mysql-external-service
  namespace: laravel-app
spec:
  selector:
    app: mysql
  ports:
  - name: mysql
    port: 3306
    targetPort: 3306
    nodePort: 30307
  type: NodePort
---
apiVersion: v1
kind: Service
metadata:
  name: redis-external-service
  namespace: laravel-app
spec:
  selector:
    app: redis
  ports:
  - name: redis
    port: 6379
    targetPort: 6379
    nodePort: 30380
  type: NodePort
---
# ================================
# STORAGE CLASS (Optional)
# ================================
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-storage
provisioner: kubernetes.io/no-provisioner
volumeBindingMode: WaitForFirstConsumer
