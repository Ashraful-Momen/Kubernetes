#!/bin/bash

# Laravel Application Kubernetes Deployment Script
# Make sure kubectl is configured and cluster is accessible

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
NAMESPACE="laravel-app"
MANIFEST_FILE="laravel-k8s-manifests.yaml"
DOCKER_IMAGE="instasure-dockerized_app:latest"
REGISTRY_IMAGE=""

# Functions
print_step() {
    echo -e "${BLUE}[STEP]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

check_requirements() {
    print_step "Checking requirements..."
    
    # Check kubectl
    if ! command -v kubectl &> /dev/null; then
        print_error "kubectl is not installed or not in PATH"
        exit 1
    fi
    
    # Check cluster connection
    if ! kubectl cluster-info &> /dev/null; then
        print_error "Cannot connect to Kubernetes cluster"
        exit 1
    fi
    
    # Check manifest file
    if [ ! -f "$MANIFEST_FILE" ]; then
        print_error "Manifest file $MANIFEST_FILE not found"
        exit 1
    fi
    
    print_success "Requirements check passed"
}

create_directories() {
    print_step "Creating required directories on nodes..."
    print_warning "Make sure these directories exist on your Kubernetes nodes:"
    echo "  - /data/mysql"
    echo "  - /data/redis"
    echo "  - /home/ashraful/gitlab_project/instasure-dockerized"
    
    read -p "Have you created these directories? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_error "Please create the required directories first"
        exit 1
    fi
}

build_and_push_image() {
    if [ -n "$REGISTRY_IMAGE" ]; then
        print_step "Building and pushing Docker image..."
        
        # Build image
        if docker build -t "$REGISTRY_IMAGE" .; then
            print_success "Image built successfully"
        else
            print_error "Failed to build Docker image"
            exit 1
        fi
        
        # Push image
        if docker push "$REGISTRY_IMAGE"; then
            print_success "Image pushed successfully"
        else
            print_error "Failed to push Docker image"
            exit 1
        fi
        
        # Update manifest file
        print_step "Updating manifest with new image..."
        sed -i.bak "s|$DOCKER_IMAGE|$REGISTRY_IMAGE|g" "$MANIFEST_FILE"
        print_success "Manifest updated"
    else
        print_warning "No registry image specified, using local image: $DOCKER_IMAGE"
        print_warning "Make sure this image is available on all nodes"
    fi
}

deploy_application() {
    print_step "Deploying application to Kubernetes..."
    
    if kubectl apply -f "$MANIFEST_FILE"; then
        print_success "Application deployed successfully"
    else
        print_error "Failed to deploy application"
        exit 1
    fi
}

wait_for_pods() {
    print_step "Waiting for pods to be ready..."
    
    # Wait for deployments to be ready
    deployments=("mysql-deployment" "redis-deployment" "laravel-app-deployment" "nginx-deployment" "phpmyadmin-deployment")
    
    for deployment in "${deployments[@]}"; do
        print_step "Waiting for $deployment to be ready..."
        if kubectl wait --for=condition=available --timeout=300s deployment/$deployment -n $NAMESPACE; then
            print_success "$deployment is ready"
        else
            print_warning "$deployment might not be ready yet"
        fi
    done
}

show_access_info() {
    print_success "Deployment completed!"
    echo
    echo -e "${BLUE}Access Information:${NC}"
    
    # Get node IP
    NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="ExternalIP")].address}')
    if [ -z "$NODE_IP" ]; then
        NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
    fi
    
    echo "Node IP: $NODE_IP"
    echo
    echo "Services:"
    echo "  - Web Application: http://$NODE_IP:30080"
    echo "  - PHPMyAdmin: http://$NODE_IP:30081"
    echo "  - MySQL (external): $NODE_IP:30307"
    echo "  - Redis (external): $NODE_IP:30380"
    echo
    echo "Database Credentials:"
    echo "  - Database: laravel_db"
    echo "  - Username: laravel_user"
    echo "  - Password: laravel_password"
    echo "  - Root Password: root_password"
}

check_status() {
    print_step "Checking deployment status..."
    
    echo "Pods:"
    kubectl get pods -n $NAMESPACE
    echo
    echo "Services:"
    kubectl get svc -n $NAMESPACE
    echo
    echo "PVCs:"
    kubectl get pvc -n $NAMESPACE
}

show_logs() {
    print_step "Recent logs from Laravel app:"
    kubectl logs -n $NAMESPACE deployment/laravel-app-deployment --tail=20
    echo
    print_step "Recent logs from Nginx:"
    kubectl logs -n $NAMESPACE deployment/nginx-deployment --tail=20
}

cleanup() {
    print_step "Cleaning up deployment..."
    
    read -p "Are you sure you want to delete the entire application? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        kubectl delete namespace $NAMESPACE
        kubectl delete pv mysql-pv redis-pv app-code-pv 2>/dev/null || true
        kubectl delete storageclass local-storage 2>/dev/null || true
        print_success "Cleanup completed"
    else
        print_warning "Cleanup cancelled"
    fi
}

show_help() {
    echo "Laravel Kubernetes Deployment Script"
    echo
    echo "Usage: $0 [COMMAND] [OPTIONS]"
    echo
    echo "Commands:"
    echo "  deploy    Deploy the application (default)"
    echo "  status    Check deployment status"
    echo "  logs      Show recent logs"
    echo "  cleanup   Remove the entire deployment"
    echo "  help      Show this help message"
    echo
    echo "Options:"
    echo "  --registry-image IMAGE    Specify registry image for build and push"
    echo
    echo "Examples:"
    echo "  $0 deploy"
    echo "  $0 deploy --registry-image myregistry.com/laravel-app:v1.0"
    echo "  $0 status"
    echo "  $0 logs"
    echo "  $0 cleanup"
}

# Parse arguments
COMMAND="deploy"
while [[ $# -gt 0 ]]; do
    case $1 in
        deploy|status|logs|cleanup|help)
            COMMAND="$1"
            shift
            ;;
        --registry-image)
            REGISTRY_IMAGE="$2"
            shift 2
            ;;
        *)
            print_error "Unknown option: $1"
            show_help
            exit 1
            ;;
    esac
done

# Execute command
case $COMMAND in
    deploy)
        check_requirements
        create_directories
        build_and_push_image
        deploy_application
        wait_for_pods
        show_access_info
        ;;
    status)
        check_status
        ;;
    logs)
        show_logs
        ;;
    cleanup)
        cleanup
        ;;
    help)
        show_help
        ;;
    *)
        print_error "Unknown command: $COMMAND"
        show_help
        exit 1
        ;;
esac
